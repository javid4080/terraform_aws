# terraform_aws_kubernetes

# Prerequisite's

	1. terraform version 12 : Click here to download.
	2. AWS Account : Click here to create a free tier AWS account.
	3. PuTTy, PuTTygen, Pageant : Click here to download .
	4. Git Bash : Click here to download.
	
	
# HowToStart

	1. Open Git Bash or any equivalent terminal  and  export `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY`
	2. Make sure `terraform`  cli is in path.
	3. `git clone https://github.com/rbhokare145/terraform_aws.git`
	4. `vi /terraform_aws/dev/dev.tfvars`  : To update the user_vars as per requirements.
	5. Run terraform init
	6. Run terraform plan -var-file=dev.tfvars 
	7. Run terraform apply -var-file=dev.tfvars
	8. Enter user ip-address range to allow an ec2 instances access externally. On Google type  my-ip
	   and then pass the ip range as for ex. 123.201.100.40/32
    	9. After successfull `terraform apply` open Pageant to add the ssh private keys for forwarding and then putty to login on jumbbox, user:pass (ubuntu:ubuntu)
    	10. From jump box ssh to kubernetes master ip, inside the homedir, run `sh kubemaster.sh` and supply the inputes.
        	this step will install and configure kube master on given ec2.
       		"Enter the KubeNetwork CIDR range [10.244.0.0/16]" : 10.244.0.0/16
        	"Enter the KubeMaster static private ip" : 192.168.11.53 ( should be enter your own kubemaster node private ip )
	       (The successfull script will generate `TOKEN_NAME` and `CA_CERT`, those are required on next step
   	11. From jump box ssh to kubernetes node1 ip, inside the homedir, run `sh kubemini.sh` and supply the inputes
        	"Enter the KubeMaster static private ip : " kubemasterip
        	"Enter the token_name : " token (from step#10)
        	"Enter the ca_cert : " ca_cert  (from step#10)
         	( Nodes will take around a minute to complete cluster registrations)
    	12. Untill the Kubecluster with one master and two nodes has been setup, check cluster status with `kubectl get nodes`
    	13. From jump box ssh to kubernetes master ip, inside the homedir, run `sh kubeconfig.sh` to lable the nodes in cluster
    	14. To access the cluster from outside either from jump box or from your local workstation copy the dir `/home/ubuntu/.kube` to your local homedir
        	`scp -pr "$kubemaster-ip":/home/ubuntu/.kube .`
       


# Issue1
while making use of terraform resource `provision --> connection`, getting error "Failed to read ssh private key: no key found"
although the key does present on the given path.

# Reason : terraform v0.12 does not support private/public keys generated by PuTTygen those are in `.ppk` format.
https://aws.amazon.com/premiumsupport/knowledge-center/convert-pem-file-into-ppk/

# Solution :
1) To generate open ssh keys --> https://compbio.cornell.edu/about/resources/linux-ssh-keys-and-ssh-key-generation/
   ssh-keygen -t rsa -b 2048  (do not specify any passphrase while key creation, as terraform again not support encrypted private keys)
2) Step#1 does solve the problem for terraform to login on ec2 and execute given provision instructions
   but, its not possible to login to an instance by using the open-ssh keys which are in .pem format. thus
3) Make use of PuTTy-Gen to convert the given private key (which is in .pem format) to .ppk
4) Open PuTTygen --> click on Conversions -> import key --> and then same private key (.ppk) and public key
5) Make use of the available .ppk private key to login inside ec2 by using putty


# Issue2

I have seen this issue when creating shell scripts in Windows env using pycharm editor and then porting over to run on a Unix environment.

The script execution getting failed with "bin/bash^M: bad interpreter: No such file or directory"

# Reason : Unix uses different line endings so can't read the file you created on Windows. Hence it is seeing ^M as an illegal character.

If you want to write a file on Windows and then port over, make sure your editor is set to create files in UNIX format.


# Solution :

1) In notepad++ in the bottom right of the screen, it tells you the document format. By default, it will say Dos\Windows.   To change it go to
2) Pycharm LineSeperator to change to Unix 
Try running dos2unix on the script http://dos2unix.sourceforge.net/
